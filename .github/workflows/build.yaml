name: Deploy
on:
  pull_request:
  push:
    branches:
      - master
concurrency:
  group: ${{ github.event_name == 'push' && 'push-global' || github.run_id }}
  cancel-in-progress: true

permissions:
  issues: write

jobs:
  update_http_client:
    name: Update Http Client
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            isHttpClientChange:
              - 'cli/http-client/**'
      - name: Update Http Client
        if: ${{ steps.filter.outputs.isHttpClientChange == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sh ./gradlew :cli:http-client:build -x test
          mv -f cli/http-client/build/libs/http-client-${{ steps.env.outputs.APP_VERSION }}.jar spectre-common/src/main/resources/http-client.jar
          VERSION="${{ github.event.release.tag_name }}"
          BRANCH="${{ github.head_ref }}"

          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git checkout -b $BRANCH
          git commit -am "Update http client"
          git push --set-upstream origin $BRANCH

  test:
    runs-on: ubuntu-latest
    name: Run Tests
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup k3s
        id: k3s
        uses: fenio/setup-k3s@v1

      - name: Setup Test Environment
        id: env
        env:
          KUBECONFIG: ${{ steps.k3s.outputs.kubeconfig }}
        run: |
          kubectl apply -f deploy/k8s-full-roles.yaml
          kubectl apply -f spectre-core/src/test/resources/k8s-deploy.yaml
          sleep 5
          kubectl wait --for=condition=ready pod -l app=math-game -n spectre --timeout=60s
          K8S_TOKEN=`kubectl create token spectre -n spectre`
          echo "token=$K8S_TOKEN" >> $GITHUB_OUTPUT
          
          APP_VERSION=`cat gradle.properties | grep spectreVersion | cut -d'=' -f2 | tr -d ' '`
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_OUTPUT

      - name: Tests
        id: test
        env:
          K8S_ENDPOINT: https://127.0.0.1:6443
          K8S_TOKEN: ${{ steps.env.outputs.token }}
        run: sh ./gradlew spectre-core:test

      - name: Upload Test Output
        if: failure() && steps.test.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: ./spectre-core/build/reports/tests/test/**/*

      - name: Publish to Cloudflare Pages
        if: failure() && steps.test.outcome == 'failure' && github.event_name == 'pull_request'
        uses: cloudflare/wrangler-action@v3
        id: cloudflare
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          command: 'pages deploy ${{ github.workspace }}/spectre-core/build/reports/tests/test/ --project-name=${{ vars.CLOUDFLARE_PROJECT_NAME }}'
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Comment
        uses: actions-cool/issues-helper@v3
        if: failure() && steps.test.outcome == 'failure' && github.event_name == 'pull_request'
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ❌ Run test failed, click [here](${{ steps.cloudflare.outputs.deployment-url }}) to check the test report.

      - name: Add Summary
        if: failure() && steps.test.outcome == 'failure' && github.event_name == 'pull_request'
        run: |
          echo "# Test Report" >> $GITHUB_STEP_SUMMARY
          echo "❌ Run test failed, click [here](${{ steps.cloudflare.outputs.deployment-url }}) to check the test report." >> $GITHUB_STEP_SUMMARY

  build:
    runs-on: ubuntu-latest
    needs: test
    name: Build Project
    outputs:
      app_version: ${{ steps.env.outputs.APP_VERSION }}
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Environment
        id: env
        run: |
          APP_VERSION=`cat gradle.properties | grep spectreVersion | cut -d'=' -f2 | tr -d ' '`
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_OUTPUT

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'pnpm'
          cache-dependency-path: spectre-frontend/pnpm-lock.yaml

      - name: Build Frontend
        working-directory: spectre-frontend
        env:
          VITE_IS_PREVIEW_ENV: true
          VITE_APP_VERSION: ${{ steps.env.outputs.APP_VERSION }}-${{ github.sha }}
        run: pnpm i && pnpm run build

      - name: Build Backend
        run: >
          mkdir spectre-core/src/main/resources/static/  &&
          cp -r spectre-frontend/dist/* spectre-core/src/main/resources/static/ &&
          sh ./gradlew build -x test

      - name: Upload Spectre
        uses: actions/upload-artifact@v4
        with:
          name: 'spectre'
          path: spectre-core/build/libs/spectre-core-${{ steps.env.outputs.APP_VERSION }}.jar
  upload:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' }}
    name: Upload Image
    needs: build
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v4

      - name: Enable QEMU
        uses: docker/setup-qemu-action@v3

      # Step 2: 安装 buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - uses: actions/download-artifact@v4
        with:
          name: spectre
          path: deploy/image

      - name: Rename Package
        run: mv deploy/image/spectre-core-${{ needs.build.outputs.app_version }}.jar deploy/image/spectre.jar

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: public

      - name: Build And Push Image
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --file deploy/image/Dockerfile \
            --push \
            -t public.ecr.aws/b9z8l9n7/vudsen/spectre:${{ needs.build.outputs.app_version }}-${{ github.sha }} \
            deploy/image

      - name: Restart Service
        id: reboot
        env:
          AWS_REGION: ap-southeast-1
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ vars.AWS_INSTANCE_IDS }}" \
            --document-name "AWS-RunShellScript" \
            --parameters commands='["sh /opt/spectre/reboot.sh ${{ needs.build.outputs.app_version }}-${{ github.sha }}"]' \
            --query "Command.CommandId" \
            --output text)
          
          set +e
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ vars.AWS_INSTANCE_IDS }}"
          rc=$?
          set -e
          
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ vars.AWS_INSTANCE_IDS }}" \
            --query "StandardOutputContent"
          
          echo "--- Exit Code ---"
          aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ vars.AWS_INSTANCE_IDS }}" \
          --query "ResponseCode"
          
          echo "--- Stdout ---"
          aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ vars.AWS_INSTANCE_IDS }}" \
          --query "StandardOutputContent"
    
          echo "--- Stderr ---"
          aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "${{ vars.AWS_INSTANCE_IDS }}" \
          --query "StandardErrorContent"

          if [ $rc -ne 0 ]; then
            echo "Execute command failed, exit code: $rc"
          fi
          
          exit $rc
